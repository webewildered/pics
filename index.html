<html>
<head> 
<title>Pics</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>

function getGalleryKey()
{
    return window.location.search.substring(1);
}

function addImage(galleryEntry)
{
    $('<img>').attr('src', 'thumbs/' + galleryEntry.thumb).appendTo(thumbs);
    $('<br>').appendTo(thumbs);
}

async function upload(event)
{
    event.preventDefault();
    const form = document.querySelector('#uploadForm');
    const formData = new FormData(form);
    formData.append("galleryKey", getGalleryKey());
    const response = await fetch('api/upload', { method: 'POST', body: formData });
    var count = 0;
    for await (const chunk of response.body)
    {
        const text = new TextDecoder().decode(chunk);
        console.log(`chunk: ${text}`);
        const galleryEntry = JSON.parse(text);
        if (Object.hasOwn(galleryEntry, 'error'))
        {
            console.log('Error: ' + galleryEntry.error);
        }
        else
        {
            addImage(galleryEntry);
            count++;
        }
    }
    console.log('Uploaded ' + count + ' images');
}

window.onload = () =>
{
    $('#uploadButton').on('click', upload);

    // Load the gallery
    const thumbs = $('#thumbs');
    fetch('galleries/' + getGalleryKey() + '.json')
        .then((response) => response.json())
        .then((gallery) =>
        {
            for (const galleryEntry of gallery.images)
            {
                addImage(galleryEntry);
            }
        })
        .catch((error) =>
        {
            $('<span>error: ' + error + '</span>').appendTo(thumbs);
        });
}

</script>
</head>
<body>
    <!-- top bar -->
    <div>
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" id="fileInput" name="files" multiple accept="image/jpeg,image/heic"/>
            <button id="uploadButton">+</button>
        </form>
    </div>

    <!-- thumbnail grid -->
    <div id="thumbs">
    </div>
</body>
</html>