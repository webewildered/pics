<html>
<head> 
<title>hello admin</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>

function getAdminKey()
{
    return window.location.search.substring(1);
}

function addLog(str)
{
    logDiv = $('#log');
    $('<span>').text(str).appendTo(logDiv);
    $('<br>').appendTo(logDiv);
}

async function addGallery(keys)
{
    const galleryKey = keys.galleryKey;
    const writeKey = keys.writeKey;
    const galleryList = $('#galleryList');
    const li = $('<li>').appendTo(galleryList);
    const link = $('<a>').attr('href', 'index.html?' + writeKey).text(galleryKey).appendTo(li);
    $('<span>').text(' ').appendTo(li);
    $('<button>').text('delete').click(() => deleteGallery(li, galleryKey)).appendTo(li);
    fetch('galleries/' + galleryKey + '.json')
        .then((response) => response.json())
        .then((gallery) =>
        {
            link.text(gallery.name + ' (' + galleryKey + ')');
        })
        .catch((error) =>
        {
            link.text(galleryKey + ' (missing!)');
        });
}

// On page load
window.onload = () =>
{
    // Load the gallery list
    fetch('admin/' + getAdminKey() + '.json')
        .then((response) => response.json())
        .then((json) =>
        {
            if (json.type == "admin")
            {
                for (const galleryKey of json.galleries)
                {
                    addGallery(galleryKey);
                }
                $('#adminPanel').show();
            }
        })
        .catch((error) =>
        {
            addLog('load error: ' + error);
        });
}

function adminApi(api, request)
{
    request.adminKey = getAdminKey();
    return new Promise((resolve, reject) =>
    {
        fetch('api/' + api, { method: 'POST', body: JSON.stringify(request) })
            .then((response) =>
            {
                if (response.status !== 200)
                {
                    response.text()
                        .then((text) => 
                        {
                            reject(api + ' failed:\n' + text);
                        });
                }
                else
                {
                    resolve(response);
                }
            });
    })
    return ;
}

// On create gallery button click
function createGallery()
{
    adminApi('createGallery', { name: $('#galleryName').val() })
        .then((response) => response.json())
        .then((json) => addGallery(json))
        .catch((err) => console.log(err));
}

// On delete gallery button click
function deleteGallery(li, galleryKey)
{
    adminApi('deleteGallery', { galleryKey: galleryKey })
        .then((response) => response.text())
        .then((response) => { li.remove(); })
        .catch((err) => console.log(err));
}

var n = 1;
function test()
{
    adminApi('test', {message: 'n ' + (n++)})
        .catch((err) => console.log(err));
}

</script>
</head>
<body>
    <div id="adminPanel" hidden>
        <input type="text" placeholder="New gallery name" id="galleryName"></input>
        <button onclick="createGallery()">Create gallery</button>
        <br />
        <ul id="galleryList">
        </ul>
    </div>
    <br /><br />
    <button onclick="test()">test</button>
    <br /><br />
    <div id="log"></span>
</body>
</html>